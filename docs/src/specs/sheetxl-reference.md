# SheetXL Reference Snapshot (Local)

This document summarizes the local, gitignored copy of SheetXL source placed under
`docs/src/specs/sheetxl/`. It is intended as a parity reference for implementing
similar primitives/formulas/utils in Rust.

## Snapshot Location

- `docs/src/specs/sheetxl/primitives`
- `docs/src/specs/sheetxl/formulas`
- `docs/src/specs/sheetxl/utils`

Note: These directories are excluded from git (per `.gitignore`). This doc is the
canonical tracked reference.

## Packages Overview

### @sheetxl/primitives
Core types and interfaces used by formulas:

- **Scalar types**: `Scalar`, `JSScalar`, and update variants in `Scalar.ts`.
- **ScalarType enum**: `ScalarType` and helpers in `ScalarType.ts`.
- **Ranges**: `IRange` and `IReferenceRange` (rich iteration, orientation, value options).
- **Function metadata**: `IFunction` declarations, parameters, return type descriptors.
- **Formula context/runtime**: `IFormulaContext`, `IRuntime`, and `FormulaContext` stub.
- **Errors**: `FormulaError` with standard spreadsheet error labels/codes.
- **Observable**: basic pub/sub utility.
- **IRichData**: JSON-serializable rich value interface.

Key entry: `docs/src/specs/sheetxl/primitives/src/index.ts`.

### @sheetxl/formulas
Large collection of Excel-compatible functions, organized by category. Relies on
`@sheetxl/primitives` and a build-time binding step.

- Entry point: `src/index.ts` exposes `initialize(getContext)` and version/count
  (currently stubbed; actual bindings generated by build tooling).
- Categories (non-exhaustive):
  - mathTrig, statistical, text, logical, information
  - dateTime, financial, engineering
  - database, cube, web, testing
- Utilities: `src/_utils` includes shared helpers/types.
- Dependencies: `jstat`, `bessel`, `bahttext` (optional XML dependencies for FILTERXML).

### @sheetxl/utils
General utilities used by SheetXL projects:

- **Coords**: `CellCoords`, `RangeCoords`, orientation enums, range ops.
- **Clipboard**: referenceable clipboard + internal clipboard helpers.
- **Notifier**: task progress and notification interfaces.
- **Undo**: `UndoManager` and operation interfaces.
- **Types/Utils**: JSON helpers, errors, throttling/debounce, buffer/image utils.
- **Mode**: edit mode interfaces.

Key entry: `docs/src/specs/sheetxl/utils/src/index.ts`.

## Suggested Rust Parity Map

### piptable-primitives (Rust)
- `Scalar` -> `Value` (core) or a restricted scalar enum for formula eval.
- `IRange` -> range view trait on `Sheet` (iter, map, broadcast, orientation).
- `FormulaError` -> error enum mapping to Excel-style error codes/labels.
- `IFunction` -> metadata for DSL + formula registry (signature + return types).

### piptable-formulas (Rust)
- Implement categories incrementally (Math/Text/Logical/Date first).
- Provide registry and lookup by canonical formula name.
- Keep core evaluation engine independent of UI/runtime.

### piptable-utils (Rust)
- Port only what formula engine needs (coords, range ops, errors, throttling as needed).
- UI-specific utilities (clipboard, DOM-related) remain in TS for the frontend.

## Notes for Implementation

- `@sheetxl/formulas` uses a build-time binding step; in Rust this maps to a
  static registry or generated match table.
- Many formula functions accept `IRange`, not just scalars; parity requires
  range-aware evaluation, broadcasting, and aggregation.
- Error semantics are defined in `FormulaError` (labels like `#DIV/0!`, `#N/A`).

## Next Steps

- Extract a minimal, prioritized function list from `formulas/src` and map it
  to Rust implementations.
- Define a Rust `Range` trait that mirrors `IRange` iterator/value semantics.
- Decide on error label mapping and propagation rules.
